# VSCode Copilot Automation Extension - Makefile
# é–‹ç™ºãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®è‡ªå‹•åŒ–

.PHONY: help install build package clean dev watch test uninstall reinstall

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "ğŸš€ VSCode Copilot Automation Extension - Make Commands"
	@echo ""
	@echo "ğŸ“¦ Build & Install:"
	@echo "  make install     - ãƒ•ãƒ«ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make reinstall   - ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make build       - TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®ã¿"
	@echo "  make package     - VSIXãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆã®ã¿"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  make clean       - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  make uninstall   - æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo ""
	@echo "ğŸ”§ Development:"
	@echo "  make dev         - é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆwatch + è‡ªå‹•å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰"
	@echo "  make watch       - TypeScript watch ãƒ¢ãƒ¼ãƒ‰"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test        - æ‹¡å¼µæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	npm install

# TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
build: deps
	@echo "ğŸ”¨ Compiling TypeScript..."
	npm run compile

# VSIXãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
package: build clean-vsix
	@echo "ğŸ“¦ Creating VSIX package..."
	vsce package --allow-missing-repository --allow-star-activation

# æ‹¡å¼µæ©Ÿèƒ½ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ•ãƒ«ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
install: package
	@echo "âš¡ Installing extension..."
	@$(MAKE) uninstall || true
	@VSIX_FILE=$$(ls *.vsix | head -n 1); \
	if [ -n "$$VSIX_FILE" ]; then \
		echo "Installing $$VSIX_FILE..."; \
		code --install-extension "$$VSIX_FILE"; \
		echo "âœ… Extension installed successfully!"; \
		echo ""; \
		echo "ğŸ”„ Reloading VSCode window..."; \
		$(MAKE) reload-vscode; \
		echo "âœ… VSCode reloaded! Extension is ready to use."; \
	else \
		echo "âŒ No VSIX file found!"; \
		exit 1; \
	fi

# VSCodeã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªãƒ­ãƒ¼ãƒ‰ (via Singleton Manager)
reload-vscode:
	@echo "ğŸ”„ Safely reloading VSCode via Singleton Process Manager..."
	@python3 ../scripts/reload_helper.py

# æ‹¡å¼µæ©Ÿèƒ½ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uninstall:
	@echo "ğŸ—‘ï¸ Uninstalling existing extension..."
	@code --uninstall-extension undefined_publisher.copilot-automation-extension || true
	@code --uninstall-extension windsurf-dev.copilot-automation-extension || true

# å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
reinstall: uninstall install

# VSIXãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean-vsix:
	@echo "ğŸ—‘ï¸ Cleaning up old VSIX files..."
	@rm -f *.vsix

# å…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean: clean-vsix
	@echo "ğŸ§¹ Cleaning up build artifacts..."
	@rm -rf out/
	@rm -rf node_modules/

# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆwatch + è‡ªå‹•å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
dev:
	@echo "ğŸ”§ Starting development mode..."
	@echo "TypeScript will be compiled in watch mode."
	@echo "Run 'make reinstall' in another terminal when you want to test changes."
	npm run watch

# TypeScript watch ãƒ¢ãƒ¼ãƒ‰
watch:
	@echo "ğŸ‘€ Starting TypeScript watch mode..."
	npm run watch

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test: build
	@echo "ğŸ§ª Running tests..."
	@echo "Testing extension installation..."
	@if code --list-extensions | grep -q "copilot-automation-extension"; then \
		echo "âœ… Extension is installed"; \
	else \
		echo "âŒ Extension is not installed"; \
		exit 1; \
	fi

# æ‹¡å¼µæ©Ÿèƒ½ã®çŠ¶æ…‹ç¢ºèª
status:
	@echo "ğŸ“Š Extension Status:"
	@echo "Installed extensions:"
	@code --list-extensions | grep -i copilot || echo "No copilot extensions found"
	@echo ""
	@echo "VSIX files in current directory:"
	@ls -la *.vsix 2>/dev/null || echo "No VSIX files found"

# é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup:
	@echo "ğŸ› ï¸ Setting up development environment..."
	@$(MAKE) deps
	@echo "Installing vsce globally..."
	@npm install -g @vscode/vsce || echo "vsce already installed or permission denied"
	@echo "âœ… Development environment ready!"
